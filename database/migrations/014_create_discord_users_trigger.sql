-- Trigger para criar automaticamente registro na tabela discord_users quando um novo usuário é criado
DELIMITER $$

DROP TRIGGER IF EXISTS create_discord_user_on_user_create$$

CREATE TRIGGER create_discord_user_on_user_create
AFTER INSERT ON users
FOR EACH ROW
BEGIN
    DECLARE @random_code VARCHAR(32);

    -- Gerar código de verificação único de 32 caracteres
    -- Usa caracteres alfanuméricos sem ambiguidade (sem O/0, l/1, I)
    SET @random_code = CONCAT(
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1),
        SUBSTRING('ABCDEFGHJKLMNPQRSTUVWXYZ23456789', FLOOR(RAND()*31)+1, 1)
    );

    INSERT INTO discord_users (user_id, verification_code, discord_id)
    VALUES (NEW.id, @random_code, '')
    ON DUPLICATE KEY UPDATE updated_at = NOW();
END$$

DELIMITER ;
